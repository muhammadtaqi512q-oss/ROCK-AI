<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROCK AI</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* ChatGPT-style bubble animation */
        .ai-bubble {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>

    <script type="module">
        /* ---------------------- Firebase ------------------------- */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof _firebase_config !== 'undefined' ? JSON.parse(_firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;

        async function initializeFirebaseAndAuth() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    setLogLevel('debug'); 

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    userId = auth.currentUser?.uid;
                    console.log("Firebase authenticated:", userId);
                }
            } catch (e) {
                console.error("Firebase init failed:", e);
            }
        }

        /* ---------------------- Backoff Fetch ------------------------- */
        async function fetchWithBackoff(url, opts, retries = 5) {
            for (let i = 1; i <= retries; i++) {
                try {
                    const r = await fetch(url, opts);
                    if (r.ok) return r;

                    if (r.status === 429 && i < retries) {
                        const delay = 2 ** i * 1000;
                        await new Promise(res => setTimeout(res, delay));
                        continue;
                    }
                    throw new Error(API failed: ${r.status});
                } catch (e) {
                    if (i === retries) throw e;
                    await new Promise(res => setTimeout(res, 2 ** i * 1000));
                }
            }
        }

        /* ---------------------- Gemini ------------------------- */
        async function generateAIContent(prompt) {
            const apiKey = "AIzaSyC1v0qpnQ67wdZ-F1JiAMZ2d-HH4HFF-WU";
            const url = https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey};

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: "You are a helpful and friendly assistant." }]
                }
            };

            const res = await fetchWithBackoff(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
            return text || "Error: No response from AI.";
        }

        /* ---------------------- Voice Functions ------------------------- */
        function speakText(text) {
            const u = new SpeechSynthesisUtterance(text);
            u.lang = "en-US";
            u.rate = 1;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(u);
        }

        function startVoiceInput(target) {
            const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!Rec) return alert("Voice input not supported.");

            const rec = new Rec();
            rec.lang = "en-US";
            rec.interimResults = false;
            rec.start();

            rec.onresult = e => target.value = e.results[0][0].transcript;
        }

        /* ---------------------- UI Logic ------------------------- */
        window.onload = async () => {
            await initializeFirebaseAndAuth();

            const promptInput = document.getElementById("promptInput");
            const generateButton = document.getElementById("generateButton");
            const loadingIndicator = document.getElementById("loadingIndicator");
            const responseContainer = document.getElementById("responseContainer");
            const voiceInputButton = document.getElementById("voiceInputButton");
            const repeatVoiceButton = document.getElementById("repeatVoiceButton");

            let lastAIResponse = "";

            voiceInputButton.onclick = () => startVoiceInput(promptInput);
            repeatVoiceButton.onclick = () => speakText(lastAIResponse);

            generateButton.onclick = async () => {
                const prompt = promptInput.value.trim();
                if (!prompt) return;

                loadingIndicator.classList.remove("hidden");
                generateButton.disabled = true;
                responseContainer.innerHTML = "";

                try {
                    const text = await generateAIContent(prompt);

                    responseContainer.innerHTML = 
                        <div class="ai-bubble bg-white dark:bg-gray-800 
                                    text-gray-900 dark:text-gray-100 p-5 
                                    rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">
                            ${text.replace(/\n/g, "<br>")}
                        </div>
                    ;

                    lastAIResponse = text;
                    repeatVoiceButton.classList.remove("hidden");
                    speakText(text);

                } catch (e) {
                    responseContainer.innerHTML = <p class="text-red-600">${e}</p>;
                }

                loadingIndicator.classList.add("hidden");
                generateButton.disabled = false;
            };
        };
    </script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 min-h-screen flex flex-col items-center p-6">

    <div class="w-full max-w-3xl">

        <div class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800 dark:text-gray-100">
                ROCK AI
            </h1>
            <p class="text-gray-500 dark:text-gray-400 mt-2">
                Built by  ê§à¼’ğ“œğ“¾ğ“±ğ“ªğ“¶ğ“¶ğ“ªğ“­ğ“£ğ“ªğ“ºğ“²à¼’ê§‚
            </p>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">

            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                Your Prompt
            </label>

            <textarea id="promptInput" rows="4"
                class="w-full p-4 bg-gray-50 dark:bg-gray-900 border border-gray-300 
                       dark:border-gray-700 text-gray-800 dark:text-gray-200 
                       rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500 transition"
                placeholder="Ask the AI anything..."></textarea>

            <div class="mt-4 flex items-center gap-3">

                <button id="generateButton"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 
                           rounded-xl shadow-md transition-all">
                    âš™ï¸ Generate
                </button>

                <button id="voiceInputButton"
                    class="bg-gray-700 hover:bg-gray-800 text-white py-3 px-4 rounded-xl shadow transition">
                    ğŸ¤
                </button>

                <button id="repeatVoiceButton"
                    class="hidden bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-xl shadow transition">
                    ğŸ”Š
                </button>

            </div>
        </div>

        <div id="loadingIndicator" class="hidden mt-6 text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-4 border-blue-600 mx-auto"></div>
            <p class="mt-3 text-gray-600 dark:text-gray-300">Thinking...</p>
        </div>

        <div id="responseContainer" class="mt-8 space-y-4"></div>

    </div>

</body>
</html>
